#
#  Copyright Â© 2025 Agora
#  This file is part of TEN Framework, an open source project.
#  Licensed under the Apache License, Version 2.0, with certain conditions.
#  Refer to the "LICENSE" file in the root directory for more information.
#

# ç¼–è¯‘å™¨è®¾ç½® - æ”¹ä¸ºg++ä»¥æ”¯æŒC++åº“é“¾æ¥
CC = g++
CXX = g++
CFLAGS = -Wall -O2 -fPIC -std=c++11
CXXFLAGS = $(CFLAGS)
LDFLAGS_SHARED = -shared
LDFLAGS_STATIC = -r

# C++åº“é“¾æ¥è®¾ç½®
LIBS = -lm -lstdc++ -lpthread
# å¦‚æœç³»ç»Ÿä½¿ç”¨libc++ï¼Œæ·»åŠ ä»¥ä¸‹é€‰é¡¹
ifeq ($(shell ldd ../lib/Linux/x64/libten_vad.so 2>/dev/null | grep -c "libc++"), 1)
    LIBS += -lc++ -lc++abi
    CFLAGS += -stdlib=libc++
    CXXFLAGS += -stdlib=libc++
endif

# ç›®å½•è®¾ç½®
INCLUDE_DIR = ../include
LIB_DIR = ../lib/Linux/x64
BUILD_DIR = build
EXAMPLES_DIR = .

# æºæ–‡ä»¶
STATE_MACHINE_SOURCE = ten_vad_state_machine.c
EXAMPLE_SOURCE = vad_state_example.c

# ç›®æ ‡æ–‡ä»¶
STATE_MACHINE_OBJ = $(BUILD_DIR)/ten_vad_state_machine.o

# åº“æ–‡ä»¶
SHARED_LIB = $(BUILD_DIR)/libten_vad_state_machine.so
STATIC_LIB = $(BUILD_DIR)/libten_vad_state_machine.a
TEN_VAD_LIB = $(LIB_DIR)/libten_vad.so

# å¯æ‰§è¡Œæ–‡ä»¶
EXAMPLE_EXEC = $(BUILD_DIR)/vad_state_example

# å¹³å°æ£€æµ‹
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Darwin)
    LDFLAGS_SHARED = -dynamiclib
    SHARED_LIB = $(BUILD_DIR)/libten_vad_state_machine.dylib
    CFLAGS += -fvisibility=hidden
    CXXFLAGS += -fvisibility=hidden
endif

# é»˜è®¤ç›®æ ‡ - å…ˆæ£€æŸ¥ä¾èµ–å†æ„å»º
all: check-deps $(SHARED_LIB) $(STATIC_LIB) $(EXAMPLE_EXEC)

# åˆ›å»ºæ„å»ºç›®å½•
$(BUILD_DIR):
	mkdir -p $(BUILD_DIR)

# æ£€æŸ¥ä¾èµ– - ä½œä¸ºç‹¬ç«‹çš„ç›®æ ‡ï¼Œä¸æ˜¯æ–‡ä»¶ä¾èµ–
check-deps:
	@echo "ğŸ” æ£€æŸ¥ä¾èµ–..."
	@if [ ! -f "$(TEN_VAD_LIB)" ]; then \
		echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° $(TEN_VAD_LIB)"; \
		echo "   è¯·ç¡®ä¿å·²æœ‰çš„ libten_vad.so ä½äº $(LIB_DIR) ç›®å½•"; \
		exit 1; \
	fi
	@if [ ! -f "$(INCLUDE_DIR)/ten_vad.h" ]; then \
		echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° $(INCLUDE_DIR)/ten_vad.h"; \
		exit 1; \
	fi
	@if [ ! -f "$(STATE_MACHINE_SOURCE)" ]; then \
		echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° $(STATE_MACHINE_SOURCE)"; \
		exit 1; \
	fi
	@if [ ! -f "$(EXAMPLE_SOURCE)" ]; then \
		echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° $(EXAMPLE_SOURCE)"; \
		exit 1; \
	fi
	@echo "âœ… ä¾èµ–æ£€æŸ¥é€šè¿‡"
	@echo "ğŸ” æ£€æŸ¥libten_vad.soçš„ä¾èµ–..."
	@ldd $(TEN_VAD_LIB) || echo "âš ï¸  æ— æ³•æ£€æŸ¥åŠ¨æ€åº“ä¾èµ–"

# ç¼–è¯‘çŠ¶æ€æœºç›®æ ‡æ–‡ä»¶
$(STATE_MACHINE_OBJ): $(STATE_MACHINE_SOURCE) | $(BUILD_DIR)
	@echo "ğŸ”¨ ç¼–è¯‘çŠ¶æ€æœºç›®æ ‡æ–‡ä»¶..."
	$(CC) $(CFLAGS) -DTENVAD_STATE_MACHINE_EXPORTS -I$(INCLUDE_DIR) -c $< -o $@

# æ„å»ºåŠ¨æ€åº“
$(SHARED_LIB): $(STATE_MACHINE_OBJ)
	@echo "ğŸ“¦ æ„å»ºçŠ¶æ€æœºåŠ¨æ€åº“..."
	$(CC) $(LDFLAGS_SHARED) -o $@ $^ -L$(LIB_DIR) -lten_vad $(LIBS)

# æ„å»ºé™æ€åº“
$(STATIC_LIB): $(STATE_MACHINE_OBJ)
	@echo "ğŸ“¦ æ„å»ºçŠ¶æ€æœºé™æ€åº“..."
	ar rcs $@ $^

# æ„å»ºç¤ºä¾‹ç¨‹åº - æ·»åŠ rpathä»¥ä¾¿è¿è¡Œæ—¶æ‰¾åˆ°åº“
$(EXAMPLE_EXEC): $(EXAMPLE_SOURCE) $(SHARED_LIB) | $(BUILD_DIR)
	@echo "ğŸ”¨ æ„å»ºç¤ºä¾‹ç¨‹åº..."
	$(CC) $(CFLAGS) -I$(INCLUDE_DIR) -I$(EXAMPLES_DIR) -o $@ $< \
		-L$(BUILD_DIR) -L$(LIB_DIR) \
		-Wl,-rpath,$(BUILD_DIR) -Wl,-rpath,$(LIB_DIR) \
		-lten_vad_state_machine -lten_vad $(LIBS)

# æµ‹è¯•
test: $(EXAMPLE_EXEC)
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	@echo "è®¾ç½®åº“è·¯å¾„å¹¶è¿è¡Œç¤ºä¾‹ç¨‹åº..."
	LD_LIBRARY_PATH=$(BUILD_DIR):$(LIB_DIR) $(EXAMPLE_EXEC) ../examples/s0724-s0730.wav || \
	echo "âš ï¸  éœ€è¦éŸ³é¢‘æ–‡ä»¶è¿›è¡Œå®Œæ•´æµ‹è¯•ï¼Œä½†ç¨‹åºç¼–è¯‘æˆåŠŸ"

# å®‰è£…
install: all
	@echo "ğŸ“¥ å®‰è£…åº“æ–‡ä»¶..."
	install -d /usr/local/lib /usr/local/include
	install $(SHARED_LIB) $(STATIC_LIB) /usr/local/lib/
	install ten_vad_state_machine.h /usr/local/include/
	@echo "âœ… å®‰è£…å®Œæˆ"

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	rm -rf $(BUILD_DIR)

# æ˜¾ç¤ºæ„å»ºä¿¡æ¯
info:
	@echo "ğŸ“‹ æ„å»ºä¿¡æ¯:"
	@echo "   ç¼–è¯‘å™¨: $(CC)"
	@echo "   ç¼–è¯‘é€‰é¡¹: $(CFLAGS)"
	@echo "   é“¾æ¥åº“: $(LIBS)"
	@echo "   åŒ…å«ç›®å½•: $(INCLUDE_DIR)"
	@echo "   åº“ç›®å½•: $(LIB_DIR)"
	@echo "   æ„å»ºç›®å½•: $(BUILD_DIR)"
	@echo "   å¹³å°: $(UNAME_S)"
	@echo ""
	@echo "ğŸ“¦ æ„å»ºç›®æ ‡:"
	@echo "   åŠ¨æ€åº“: $(SHARED_LIB)"
	@echo "   é™æ€åº“: $(STATIC_LIB)"
	@echo "   ç¤ºä¾‹ç¨‹åº: $(EXAMPLE_EXEC)"

# è°ƒè¯•ä¿¡æ¯ - æ–°å¢ç›®æ ‡ç”¨äºè¯Šæ–­é—®é¢˜
debug-deps:
	@echo "ğŸ” è°ƒè¯•ä¾èµ–ä¿¡æ¯:"
	@echo "æ£€æŸ¥libten_vad.soçš„ä¾èµ–:"
	@ldd $(TEN_VAD_LIB) || echo "æ— æ³•æ£€æŸ¥ä¾èµ–"
	@echo ""
	@echo "æ£€æŸ¥ç³»ç»ŸC++åº“:"
	@ldconfig -p | grep -E "(libc\+\+|libstdc\+\+)" || echo "æœªæ‰¾åˆ°C++åº“"
	@echo ""
	@echo "æ£€æŸ¥ç¼–è¯‘å™¨ç‰ˆæœ¬:"
	@$(CC) --version
	@echo ""
	@echo "æ£€æŸ¥å¯ç”¨çš„C++åº“:"
	@find /usr/lib* /lib* -name "libc++*" -o -name "libstdc++*" 2>/dev/null | head -10

# å¸®åŠ©
help:
	@echo "ğŸ”§ å¯ç”¨ç›®æ ‡:"
	@echo "   all         - æ„å»ºæ‰€æœ‰ç›®æ ‡ (é»˜è®¤)"
	@echo "   shared      - ä»…æ„å»ºåŠ¨æ€åº“"
	@echo "   static      - ä»…æ„å»ºé™æ€åº“"
	@echo "   example     - ä»…æ„å»ºç¤ºä¾‹ç¨‹åº"
	@echo "   check-deps  - æ£€æŸ¥ä¾èµ–"
	@echo "   debug-deps  - è°ƒè¯•ä¾èµ–é—®é¢˜"
	@echo "   test        - è¿è¡Œæµ‹è¯•"
	@echo "   install     - å®‰è£…åˆ°ç³»ç»Ÿç›®å½•"
	@echo "   clean       - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "   info        - æ˜¾ç¤ºæ„å»ºä¿¡æ¯"
	@echo "   help        - æ˜¾ç¤ºæ­¤å¸®åŠ©"

# å•ç‹¬æ„å»ºç›®æ ‡ - è¿™äº›ä¹Ÿéœ€è¦å…ˆæ£€æŸ¥ä¾èµ–
shared: check-deps $(SHARED_LIB)
static: check-deps $(STATIC_LIB)
example: check-deps $(EXAMPLE_EXEC)

# å£°æ˜ä¼ªç›®æ ‡
.PHONY: all clean install test help info check-deps debug-deps shared static example
